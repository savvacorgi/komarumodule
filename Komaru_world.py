
from random import choice

from telethon.tl.types import (
    InputMessagesFilterGif,
    InputMessagesFilterPhotos,
    InputMessagesFilterVideo,
    Message,
)

from .. import loader, utils


class KomaruMod(loader.Module):
    """Random picture/video/gif from the @komaru_world"""

    strings = {
        "name": "Komaru world",
        "choosing": "<emoji document_id=5328311576736833844>ðŸ”´</emoji> Choosing {}...",
        "gif": "gif",
        "video": "video",
        "photo": "photo",
    }

    strings_ru = {
        "choosing": "<emoji document_id=5328311576736833844>ðŸ”´</emoji> ÐŸÐ¾Ð´Ð±Ð¸Ñ€Ð°ÐµÐ¼ {}...",
        "gif": "Ð²Ð°Ñˆ Ð³Ð¸Ñ„",
        "video": "Ð²Ð°ÑˆÐµ Ð²Ð¸Ð´ÐµÐ¾",
        "photo": "Ð²Ð°ÑˆÑƒ ÐºÐ°Ñ€Ñ‚Ð¸Ð½ÐºÑƒ",
    }

    SEARCH_TYPES = {
        InputMessagesFilterGif: "gif",
        InputMessagesFilterPhotos: "photo",
        InputMessagesFilterVideo: "video",
    }

    @loader.command(ru_doc="- Ð¿Ð¾Ð´Ð¾Ð±Ñ€Ð°Ñ‚ÑŒ Ñ€Ð°Ð½Ð´Ð¾Ð¼ ÐºÐ°Ñ€Ñ‚Ð¸Ð½ÐºÑƒ(Ð¿Ð¸ÐºÑ‡Ñƒ)/Ð²Ð¸Ð´ÐµÐ¾/Ð³Ð¸Ñ„")
    async def kw(self, message: Message):
        """- choose a random picture/gif/video"""
        search_type = choice(
            [
                InputMessagesFilterGif,
                InputMessagesFilterPhotos,
                InputMessagesFilterVideo,
            ]
        )
        search_type_str = self.strings(self.SEARCH_TYPES[search_type])

        msg = await utils.answer(
            message, self.strings("choosing").format(search_type_str)
        )

        chosed_msg = choice(
            [
                message_in_channel
                async for message_in_channel in self.client.iter_messages(
                    "komaru_world", limit=400, filter=search_type
                )
            ]
        )

        reply = await message.get_reply_message()
        if reply:
            reply = reply.id
        else:
            reply = None

        return await utils.answer_file(
            msg,
            chosed_msg,
            chosed_msg.text or "<b>ÐŸÐ¾Ð´Ð¾Ð±Ñ€Ð°Ð» " + search_type_str + ".</b>",
            reply_to=reply,
        )